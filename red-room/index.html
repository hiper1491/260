<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>13æœˆäº®æ›†ãƒ»ç¥å»ŸçŸ³ç¢‘ï¼ˆæ¸¬è©¦ç‰ˆï¼‰</title>

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@900&family=Noto+Serif+TC:wght@500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="./red-brain.js"></script>

  <style>
    :root{
      --theme:#A5413F;
      --bg:#F8E8E8;
      --ink:#111;
    }

    html,body{
      width:100%;
      height:100%;
      margin:0;
      background:var(--bg);
      font-family:'Noto Serif TC', serif;
      overflow:hidden;
      transition: background-color 1.1s ease;
    }

    /* âœ… ç¢ºä¿ React å¤–å±¤å¯åƒæ»¿è¦–çª—ï¼šflex ç½®ä¸­æ‰æœƒçœŸçš„ç”Ÿæ•ˆ */
    #root{
      width:100%;
      height:100%;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(900px 650px at 50% 32%, rgba(255,255,255,.42), transparent 60%),
        radial-gradient(1200px 900px at 50% 92%, rgba(0,0,0,.14), transparent 66%);
      mix-blend-mode:multiply;
      opacity:.9;
    }

    /* è¿”å›æŒ‰éˆ• */
    .home-button{
      position:fixed;
      top:32px;
      left:42px;
      width:64px;
      height:64px;
      border-radius:50%;
      background:linear-gradient(180deg,#F5F2EC,#E6E1DA);
      box-shadow:
        0 8px 16px rgba(0,0,0,.18),
        inset 0 1px 3px rgba(0,0,0,.12),
        inset 0 1px 0 rgba(255,255,255,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      z-index:140;
      transition:.2s;
      text-decoration:none;
      font-size:1.7rem;
    }
    .home-button:hover{ transform:translateY(-2px) scale(1.05); }

    .history-sidebar{
      position:fixed;
      left:42px;
      top:50%;
      transform:translateY(-50%);
      display:flex;
      flex-direction:column;
      gap:16px;
      z-index:120;
    }
    .history-stone{
      width:76px;
      height:70px;
      border-radius:40% 60% 70% 30% / 50% 40% 60% 50%;
      background:linear-gradient(180deg,#F5F2EC,#E6E1DA);
      box-shadow:
        0 18px 34px rgba(0,0,0,.22),
        inset 0 2px 10px rgba(0,0,0,.14),
        inset 0 1px 0 rgba(255,255,255,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#222;
      font-family:'Cinzel', serif;
      font-weight:900;
      font-size:1.12rem;
      cursor:pointer;
      user-select:none;
      transition:.18s;
    }
    .history-stone:hover{ transform:translateY(-2px) scale(1.03); }

    .tablet{
      width:min(760px,92vw);
      height:min(880px,90vh);
      margin:0 auto;
      position:relative;
      border-radius:56px;
      background:linear-gradient(180deg,#F1EFE8,#E6E0D6);
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 60px 110px rgba(0,0,0,.32), 0 14px 22px rgba(0,0,0,.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .tablet::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(0,0,0,.10), transparent 55%),
        radial-gradient(circle at 70% 60%, rgba(0,0,0,.08), transparent 60%),
        url("data:image/svg+xml,%3Csvg viewBox='0 0 220 220' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.55'/%3E%3C/svg%3E");
      opacity:.16;
      mix-blend-mode:multiply;
    }

    .content{
      position:relative;
      z-index:5;
      width:100%;
      height:100%;
      padding:clamp(28px, 4vh, 52px) clamp(24px, 3.4vw, 48px) clamp(24px, 3vh, 40px);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:clamp(6px, 1.2vh, 14px);
      min-height:0;
    }

    /* ========== èª¿æ€§å€åŸŸ ========== */
    .tone-area{
      height:72px;
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex:0 0 72px;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tone-dots{
      height:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tone-bars{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tone-dot{
      width:22px;
      height:22px;
      background:#000;
      border-radius:50%;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tone-bar{
      width:190px;
      height:16px;
      background:#000;
      border-radius:8px;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* åœ–é¨°å€å¡Š */
    .glyph-area{
      width:100%;
      display:flex;
      justify-content:center;
      margin-top:8px;
      margin-bottom:6px;
      flex:0 0 200px;
      align-items:center;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .glyph-frame{
      display:inline-flex;
      padding:10px;
      border-radius:24px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(0,0,0,.14);
      box-shadow:
        inset 0 4px 20px rgba(0,0,0,.30),
        inset 0 -6px 16px rgba(255,255,255,.24),
        0 14px 28px rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .glyph-frame:hover{ transform: translateY(-2px); }
    .glyph-img{
      height:180px;
      border-radius:16px;
      filter: drop-shadow(0 12px 18px rgba(0,0,0,.24));
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .kin-id{
      font-family:'Cinzel', serif;
      font-size:clamp(2.8rem, 4.8vh, 3.8rem);
      font-weight:900;
      line-height:1;
      margin-top:2px;
      min-width:9ch;
      text-align:center;
      font-variant-numeric: tabular-nums;
      font-feature-settings:"tnum" 1;
      user-select:none;
      cursor:pointer;
      color:#0E0E0E;
      flex:0 0 auto;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .kin-name{
      font-size:clamp(1.8rem, 3.5vh, 2.6rem);
      font-weight:900;
      letter-spacing:clamp(3px, .9vw, 7px);
      margin-top:4px;
      text-align:center;
      color:#111;
      flex:0 0 auto;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* æ³¢ç¬¦æ¨™ç±¤ */
    .wavespell-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 18px;
      background:rgba(0,0,0,.06);
      border-radius:999px;
      font-size:0.95rem;
      font-weight:700;
      color:#333;
      letter-spacing:1px;
      margin-top:4px;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: inset 0 1px 3px rgba(0,0,0,.08);
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .wavespell-icon{
      width:18px;
      height:18px;
      border-radius:4px;
      opacity:0.9;
    }

    .name-etch{
      width:64%;
      height:12px;
      border-radius:999px;
      background:linear-gradient(90deg, transparent 0%, var(--theme) 50%, transparent 100%);
      opacity:.64;
      margin:10px auto 12px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.14));
      flex:0 0 auto;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========== ç¸®å°æ¨¡å¼ ========== */
    .compact .tone-area{
      height:48px;
      flex-basis:48px;
      gap:6px;
    }
    .compact .tone-dots{
      height:18px;
      gap:10px;
    }
    .compact .tone-bars{
      gap:6px;
    }
    .compact .tone-dot{
      width:14px;
      height:14px;
    }
    .compact .tone-bar{
      width:120px;
      height:10px;
    }

    .compact .glyph-area{
      flex-basis:130px;
      margin-bottom:4px;
      margin-top:4px;
    }
    .compact .glyph-frame{ padding:6px; }
    .compact .glyph-img{ height:118px; }

    .compact .kin-id{
      font-size:clamp(1.8rem, 3.2vh, 2.2rem);
      margin-top:0;
    }
    .compact .kin-name{
      font-size:clamp(1.25rem, 2.4vh, 1.7rem);
      margin-top:2px;
      letter-spacing:clamp(2px, .6vw, 4px);
    }
    .compact .wavespell-badge{
      padding:5px 12px;
      font-size:0.8rem;
      gap:6px;
    }
    .compact .wavespell-icon{
      width:14px;
      height:14px;
    }
    .compact .name-etch{
      width:50%;
      height:8px;
      margin:6px auto 10px;
    }

    /* è¨Šæ¯å€ */
    .msg-stack{
      width:92%;
      display:flex;
      flex-direction:column;
      gap:clamp(16px, 2vh, 22px);
      margin-top:0;
      flex:1 1 auto;
      min-height:0;
      animation: slideInUp 0.7s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      opacity:0;
    }

    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg-box{
      background:rgba(245,242,236,.66);
      border-radius:32px;
      padding:clamp(20px, 2.4vh, 30px) clamp(22px, 2.6vw, 34px);
      border:1px solid rgba(0,0,0,.12);
      box-shadow:
        inset 0 3px 16px rgba(0,0,0,.24),
        0 12px 20px rgba(0,0,0,.14);
      backdrop-filter: blur(3px);
      flex-shrink:0;
    }
    .label{
      font-weight:900;
      opacity:.64;
      margin-bottom:12px;
      display:block;
      letter-spacing:2px;
      text-align:center;
      color:#111;
      font-size:1rem;
    }
    .content-text{
      font-size:clamp(1.15rem, 2.15vh, 1.48rem);
      line-height:1.9;
      font-weight:900;
      text-align:left;
      color:#0B0B0B;
      text-shadow:none;
      word-break:break-word;
    }

    .spinning-placeholder{
      width:92%;
      min-height:200px;
      margin:0 auto;
      border-radius:32px;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(0,0,0,.12);
      box-shadow:inset 0 2px 10px rgba(0,0,0,.16);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      letter-spacing:3px;
      opacity:.80;
      color:#111;
      flex:1 1 auto;
      font-size:1.1rem;
    }

    .footer{
      width:100%;
      margin-top:auto;
      padding-top:12px;
      padding-bottom:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:0;
      flex:0 0 auto;
    }

    .ritual-etch{
      width:min(240px, 62%);
      height:34px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      background:
        radial-gradient(120px 22px at 50% 60%, rgba(255,255,255,.16), transparent 65%);
      border-radius:999px;
      filter: drop-shadow(0 11px 19px rgba(0,0,0,.20));
    }
    .ritual-etch::before{
      content:"";
      width:13px;height:13px;border-radius:50%;
      background:var(--theme);
      box-shadow:
        inset 0 -3px 5px rgba(0,0,0,.38),
        0 9px 15px rgba(0,0,0,.18);
    }
    .ritual-etch::after{
      content:"";
      width:min(164px, 43vw);
      height:13px;
      border-radius:13px;
      background:var(--theme);
      box-shadow:
        inset 0 -4px 6px rgba(0,0,0,.42),
        0 11px 19px rgba(0,0,0,.18);
    }

    /* ========== å°é¢å…¥å£ï¼ˆç¥å»Ÿé–‹å ´ï¼‰========== */
    .pre-card{
      width:min(680px,88%);
      border-radius:56px;
      background:
        radial-gradient(ellipse at 50% 0%, rgba(255,255,255,.28), transparent 75%),
        linear-gradient(135deg, rgba(255,255,255,.15), rgba(0,0,0,.05)),
        rgba(255,255,255,.09);
      border:2px solid rgba(0,0,0,.09);
      box-shadow:
        0 52px 98px rgba(0,0,0,.24),
        inset 0 3px 20px rgba(0,0,0,.20),
        inset 0 -1px 0 rgba(255,255,255,.38);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:22px;
      margin-top:clamp(16px, 3vh, 32px);
      padding:clamp(38px, 5vh, 56px) 20px;
      cursor:pointer;
      user-select:none;
      position:relative;
      transition: transform .25s ease;
      overflow:hidden;
    }
    .pre-card:hover{ transform: translateY(-4px); }
    .pre-card:hover .pre-hunab{ transform: rotate(360deg) scale(1.08); }
    .pre-card:hover .pre-glow{ opacity: 0.9; }

    /* Hunab Kuï¼ˆæ­£åœ“ï¼‰ */
    .pre-symbol{
      width:120px;
      height:120px;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:50%;
      overflow:hidden;
    }
    .pre-hunab{
      width:100%;
      height:100%;
      display:block;
      border-radius:50%;
      object-fit:cover;
      transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      opacity:0.75;
      filter: drop-shadow(0 8px 20px rgba(0,0,0,.2));
    }

    .pre-glow{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      width:200px;
      height:200px;
      background:radial-gradient(circle, rgba(255,255,255,.5), transparent 65%);
      opacity:0.6;
      animation: pulse 3s ease-in-out infinite;
      transition: opacity 0.3s ease;
      pointer-events:none;
    }
    @keyframes pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.3; }
    }

    .pre-ornament{
      display:flex;
      align-items:center;
      gap:16px;
      margin:8px 0;
    }
    .pre-ornament-dot{
      width:6px;
      height:6px;
      background:rgba(0,0,0,.2);
      border-radius:50%;
    }
    .pre-ornament-line{
      width:60px;
      height:1px;
      background:linear-gradient(90deg, transparent, rgba(0,0,0,.2), transparent);
    }

    .pre-title{
      font-weight:900;
      letter-spacing:12px;
      color:#1A1A1A;
      font-size:2.1rem;
      text-align:center;
      margin-top:8px;
      text-shadow: 0 2px 8px rgba(0,0,0,.1);
      font-family:'Cinzel', serif;
    }
    .pre-sub{
      opacity:.65;
      font-weight:800;
      letter-spacing:5px;
      font-size:1.15rem;
      text-align:center;
      margin-top:-2px;
      color:#333;
    }
    .pre-hint{
      opacity:.45;
      font-weight:700;
      letter-spacing:2px;
      font-size:0.9rem;
      text-align:center;
      margin-top:8px;
    }

    /* ========== æ‰‹æ©Ÿç‰ˆï¼šAï¼ˆçŸ³ç¢‘å…§éƒ¨å¯æ»‘ï¼‰+ C2 å¯æ”¶åˆ + ä¸Šç§» + é™°å½±èˆ’ç·© ========== */
    @media (max-width: 520px){

      /* âœ… Aï¼šçŸ³ç¢‘å…§éƒ¨å¯æ»‘ï¼ˆä¸å‹•æ•´é èƒŒæ™¯ï¼‰ */
      .content{
        overflow-y:auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom:56px;
      }

      /* æ‰‹æ©Ÿï¼šè¨˜éŒ„çŸ³å¾€ä¸Šç§»ï¼ˆé¿å…å£“åˆ°è¨Šæ¯ï¼‰ */
      .history-sidebar{
        left:14px;
        top:110px;
        transform:none;
        gap:12px;
        z-index:160;
      }

      /* æ”¶åˆï¼šåªé¡¯ç¤ºç¬¬ä¸€é¡†ï¼ˆæœ€æ–°é‚£é¡†ï¼‰ */
      .history-sidebar:not(.open) .history-stone:not(:first-child){
        display:none;
      }

      /* æ‰‹æ©Ÿï¼šçŸ³é ­ç¸®å° */
      .history-stone{
        width:62px;
        height:58px;
        font-size:1.02rem;
        box-shadow:
          0 14px 26px rgba(0,0,0,.18),
          inset 0 2px 10px rgba(0,0,0,.12),
          inset 0 1px 0 rgba(255,255,255,.55);
      }

      /* ç´…æ¡†å£“è¿«æ„Ÿï¼šç•™ç™½ + é™°å½±æ”¶æ–‚ */
      .glyph-area{ margin-bottom:18px; }
      .glyph-img{ filter: drop-shadow(0 8px 12px rgba(0,0,0,.18)); }
      .kin-id{ margin-top:10px; }

      /* home æŒ‰éˆ•å¾®ç¸® */
      .home-button{
        top:22px;
        left:16px;
        width:58px;
        height:58px;
        font-size:1.55rem;
      }
    }

    @media (max-height: 760px){
      .tablet{ height:min(820px,90vh); }
      .glyph-img{height:160px;}
      .compact .glyph-img{height:100px;}
      .tone-area{ height:64px; flex-basis:64px; }
      .compact .tone-area{ height:44px; flex-basis:44px; }
      .glyph-area{ flex-basis:184px; }
      .compact .glyph-area{ flex-basis:116px; }
      .kin-id{ font-size:clamp(2.5rem, 4.2vh, 3.4rem); }
      .compact .kin-id{ font-size:clamp(1.6rem, 2.8vh, 2rem); }
      .kin-name{ font-size:clamp(1.6rem, 3vh, 2.2rem); }
      .compact .kin-name{ font-size:clamp(1.1rem, 2.1vh, 1.5rem); }
      .content-text{ font-size:clamp(1.05rem, 1.95vh, 1.32rem); line-height:1.8; }
      .msg-box{ padding:clamp(16px, 2vh, 24px) clamp(18px, 2vw, 26px); }
      .msg-stack{ gap:clamp(12px, 1.6vh, 18px); }
      .pre-card{ padding:clamp(28px, 4vh, 46px) 16px; gap:18px; }
      .pre-title{ font-size:1.7rem; letter-spacing:10px; }
      .pre-symbol{ width:90px; height:90px; }
      .content{ padding:clamp(24px, 3.5vh, 44px) clamp(20px, 3vw, 40px) clamp(20px, 2.5vh, 36px); }
      .home-button{ top:24px; left:32px; width:58px; height:58px; font-size:1.55rem; }
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useState,useEffect,useRef} = React;

    const TONE_NAMES=["ç£æ€§çš„","æœˆäº®çš„","é›»åŠ›çš„","è‡ªæˆ‘å­˜åœ¨çš„","è¶…é »çš„","éŸ»å¾‹çš„","å…±é³´çš„","éŠ€æ²³çš„","å¤ªé™½çš„","è¡Œæ˜Ÿçš„","å…‰è­œçš„","æ°´æ™¶çš„","å®‡å®™çš„"];
    const GLYPH_NAMES=["ç´…é¾","ç™½é¢¨","è—å¤œ","é»ƒç¨®å­","ç´…è›‡","ç™½ä¸–ç•Œæ©‹","è—æ‰‹","é»ƒæ˜Ÿæ˜Ÿ","ç´…æœˆ","ç™½ç‹—","è—çŒ´","é»ƒäºº","ç´…å¤©è¡Œè€…","ç™½å·«å¸«","è—é·¹","é»ƒæˆ°å£«","ç´…åœ°çƒ","ç™½é¡","è—é¢¨æš´","é»ƒå¤ªé™½"];

    const WAVESPELL_DATA = [
      { name: "ç´…é¾æ³¢", startKin: 1, glyphId: 0 },
      { name: "ç™½å·«å¸«æ³¢", startKin: 14, glyphId: 13 },
      { name: "è—æ‰‹æ³¢", startKin: 27, glyphId: 6 },
      { name: "é»ƒå¤ªé™½æ³¢", startKin: 40, glyphId: 19 },
      { name: "ç´…å¤©è¡Œè€…æ³¢", startKin: 53, glyphId: 12 },
      { name: "ç™½ä¸–ç•Œæ©‹æ³¢", startKin: 66, glyphId: 5 },
      { name: "è—é¢¨æš´æ³¢", startKin: 79, glyphId: 18 },
      { name: "é»ƒäººæ³¢", startKin: 92, glyphId: 11 },
      { name: "ç´…è›‡æ³¢", startKin: 105, glyphId: 4 },
      { name: "ç™½é¡æ³¢", startKin: 118, glyphId: 17 },
      { name: "è—çŒ´æ³¢", startKin: 131, glyphId: 10 },
      { name: "é»ƒç¨®å­æ³¢", startKin: 144, glyphId: 3 },
      { name: "ç´…åœ°çƒæ³¢", startKin: 157, glyphId: 16 },
      { name: "ç™½ç‹—æ³¢", startKin: 170, glyphId: 9 },
      { name: "è—å¤œæ³¢", startKin: 183, glyphId: 2 },
      { name: "é»ƒæˆ°å£«æ³¢", startKin: 196, glyphId: 15 },
      { name: "ç´…æœˆæ³¢", startKin: 209, glyphId: 8 },
      { name: "ç™½é¢¨æ³¢", startKin: 222, glyphId: 1 },
      { name: "è—é·¹æ³¢", startKin: 235, glyphId: 14 },
      { name: "é»ƒæ˜Ÿæ˜Ÿæ³¢", startKin: 248, glyphId: 7 }
    ];

    const COLORS=["red","white","blue","yellow"];
    const THEME={
      red:{main:"#A5413F",bg:"#F8E8E8"},
      white:{main:"#666666",bg:"#F2F4F6"},
      blue:{main:"#3D5A73",bg:"#E8F0F8"},
      yellow:{main:"#B39B59",bg:"#F9F8E8"}
    };

    function getTodayKin() {
      const referenceDate = new Date(2025, 6, 26);
      const referenceKin = 169;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      referenceDate.setHours(0, 0, 0, 0);

      const diffTime = today.getTime() - referenceDate.getTime();
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

      let todayKin = ((referenceKin - 1 + diffDays) % 260) + 1;
      if (todayKin <= 0) todayKin += 260;
      return todayKin;
    }

    function getWavespell(kin) {
      const wavespellIndex = Math.floor((kin - 1) / 13);
      return WAVESPELL_DATA[wavespellIndex];
    }

    function ToneDisplay({ toneId, size = "normal" }) {
      const dots = toneId % 5;
      const bars = Math.floor(toneId / 5);

      const dotClass = size === "small" ? "pre-tone-dot" : "tone-dot";
      const barClass = size === "small" ? "pre-tone-bar" : "tone-bar";
      const dotsClass = size === "small" ? "pre-tone-dots" : "tone-dots";
      const barsClass = size === "small" ? "pre-tone-bars" : "tone-bars";

      return (
        <div className={size === "small" ? "pre-tone" : "tone-area"}>
          <div className={dotsClass}>
            {[...Array(dots)].map((_, i) => <div key={i} className={dotClass}></div>)}
          </div>
          <div className={barsClass}>
            {[...Array(bars)].map((_, i) => <div key={i} className={barClass}></div>)}
          </div>
        </div>
      );
    }

    function RedRoom(){
      const [kin,setKin] = useState(1);
      const [history,setHistory] = useState([]);
      const [spinning,setSpinning] = useState(false);
      const [hasDrawn,setHasDrawn] = useState(false);
      const [showMessage,setShowMessage] = useState(false);
      const [isCompact,setIsCompact] = useState(false);

      /* âœ… C2ï¼šæ‰‹æ©Ÿç‰ˆå¯æ”¶åˆ */
      const [historyOpen,setHistoryOpen] = useState(false);

      const timerRef = useRef(null);
      const contentRef = useRef(null);

      const todayKin = getTodayKin();
      const todayTheme = THEME[COLORS[(todayKin - 1) % 4]];

      const toneId = (kin - 1) % 13 + 1;
      const glyphId = (kin - 1) % 20;
      const wavespell = getWavespell(kin);
      const theme = THEME[COLORS[(kin - 1) % 4]];

      const brain = window.RED_BRAIN_DATA || {};
      const data = brain[String(kin)] || {
        synchronicMessage: "å®‡å®™è¨Šæ¯å°é »ä¸­...",
        alignment: "è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª red-brain.js æ ¼å¼ã€‚"
      };

      useEffect(()=>{
        const activeTheme = hasDrawn ? theme : todayTheme;
        document.documentElement.style.setProperty("--bg", activeTheme.bg);
        document.documentElement.style.setProperty("--theme", activeTheme.main);
      },[theme.bg, theme.main, todayTheme.bg, todayTheme.main, hasDrawn]);

      const startSpin = ()=>{
        setHasDrawn(true);
        setSpinning(true);
        setShowMessage(false);
        setIsCompact(false);
        clearInterval(timerRef.current);
        timerRef.current = setInterval(()=>{
          setKin(Math.floor(Math.random()*260) + 1);
        }, 65);
      };

      const stopSpin = ()=>{
        clearInterval(timerRef.current);
        setSpinning(false);
        setShowMessage(false);
        setIsCompact(false);

        setTimeout(() => {
          setIsCompact(true);
          setTimeout(() => {
            setShowMessage(true);
          }, 100);
        }, 1000);

        setHistory(prev => [kin, ...prev].slice(0,5));
      };

      const toggle = ()=>{
        if(spinning) stopSpin();
        else startSpin();
      };

      const manualInput = ()=>{
        const num = prompt("å¬å–šæŒ‡å®š KIN (1-260):", kin);
        const n = parseInt(num,10);
        if(!Number.isNaN(n) && n>=1 && n<=260){
          setHasDrawn(true);
          setKin(n);
          setShowMessage(false);
          setIsCompact(false);
          setTimeout(() => {
            setIsCompact(true);
            setTimeout(() => {
              setShowMessage(true);
            }, 100);
          }, 1000);
        }
      };

      const toggleHistoryMobile = ()=>{
        if (window.innerWidth <= 520) setHistoryOpen(v=>!v);
      };

      const onPickHistory = (k, e)=>{
        if(e) e.stopPropagation();
        if(!spinning) setKin(k);
      };

      return (
        <>
          {hasDrawn && (
            <a href="../index.html" className="home-button" title="è¿”å›ä¸»é ">ğŸ </a>
          )}

          <div
            className={`history-sidebar ${historyOpen ? 'open' : ''}`}
            onClick={toggleHistoryMobile}
          >
            {history.map((k,i)=>(
              <div
                key={i}
                className="history-stone"
                onClick={(e)=>onPickHistory(k,e)}
              >
                {k}
              </div>
            ))}
          </div>

          <div style={{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"}}>
            <div className="tablet">
              <div className={`content ${isCompact ? 'compact' : ''}`} ref={contentRef}>

                {!hasDrawn ? (
                  <>
                    <div className="pre-card" onClick={toggle}>
                      <div className="pre-symbol">
                        <div className="pre-glow"></div>
                        <img className="pre-hunab" src="../images/hunab-ku.png" alt="Hunab Ku" />
                      </div>

                      <div className="pre-ornament">
                        <div className="pre-ornament-line"></div>
                        <div className="pre-ornament-dot"></div>
                        <div className="pre-ornament-line"></div>
                      </div>

                      <div className="pre-title">13æœˆäº®ç¥è«­</div>
                      <div className="pre-sub">è·Ÿè‘—ç›´è¦ºï¼Œé–å®šå°è¨˜</div>

                      <div className="pre-ornament">
                        <div className="pre-ornament-dot"></div>
                        <div className="pre-ornament-line"></div>
                        <div className="pre-ornament-dot"></div>
                      </div>

                      <div className="pre-hint">é»æ“Šé–‹å§‹å°é »</div>
                    </div>

                    <div className="footer">
                      <div className="ritual-etch"></div>
                    </div>
                  </>
                ) : (
                  <>
                    <ToneDisplay toneId={toneId} />

                    <div className="glyph-area">
                      <div className="glyph-frame" onClick={toggle} title="é»åœ–é¨°ï¼šé–‹å§‹/åœæ­¢å°é »">
                        <img className="glyph-img" src={`../images/${String(glyphId + 1).padStart(2,'0')}.png`} />
                      </div>
                    </div>

                    <div className="kin-id" onClick={manualInput}>KIN {kin}</div>
                    <div className="kin-name">{TONE_NAMES[toneId-1]}{GLYPH_NAMES[glyphId]}</div>

                    <div className="wavespell-badge">
                      <img
                        className="wavespell-icon"
                        src={`../images/${String(wavespell.glyphId + 1).padStart(2,'0')}.png`}
                        alt={wavespell.name}
                      />
                      {wavespell.name}
                    </div>

                    <div className="name-etch"></div>

                    {spinning ? (
                      <div className="spinning-placeholder">å°é »ä¸­â€¦ï¼ˆåœæ­¢å¾Œé¡¯ç¤ºå®Œæ•´è¨Šæ¯ï¼‰</div>
                    ) : showMessage && (
                      <div className="msg-stack">
                        <div className="msg-box">
                          <span className="label">âš¡ èƒ½é‡æ„Ÿæ‡‰</span>
                          <div className="content-text">{data.synchronicMessage}</div>
                        </div>

                        <div className="msg-box">
                          <span className="label">ğŸŒ± èª¿é »å»ºè­°</span>
                          <div className="content-text">{data.alignment}</div>
                        </div>
                      </div>
                    )}
                  </>
                )}

              </div>
            </div>
          </div>
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<RedRoom/>);
  </script>
</body>
</html>
