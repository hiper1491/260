<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>13æœˆäº®æ›†ãƒ»ç¥å»ŸçŸ³ç¢‘ï¼ˆæ¸¬è©¦ç‰ˆï¼‰</title>

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@900&family=Noto+Serif+TC:wght@500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="./red-brain.js"></script>

  <style>
    :root{
      --theme:#A5413F;
      --bg:#F8E8E8;
      --ink:#111;
    }

    html,body{
      width:100%;
      height:100%;
      margin:0;
      background:var(--bg);
      font-family:'Noto Serif TC', serif;
      overflow:hidden;
      transition: background-color 1.1s ease;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(900px 650px at 50% 32%, rgba(255,255,255,.42), transparent 60%),
        radial-gradient(1200px 900px at 50% 92%, rgba(0,0,0,.14), transparent 66%);
      mix-blend-mode:multiply;
      opacity:.9;
    }

    .history-sidebar{
      position:fixed;
      left:42px;
      top:50%;
      transform:translateY(-50%);
      display:flex;
      flex-direction:column;
      gap:16px;
      z-index:50;
    }
    .history-stone{
      width:76px;
      height:70px;
      border-radius:40% 60% 70% 30% / 50% 40% 60% 50%;
      background:linear-gradient(180deg,#F5F2EC,#E6E1DA);
      box-shadow:
        0 18px 34px rgba(0,0,0,.22),
        inset 0 2px 10px rgba(0,0,0,.14),
        inset 0 1px 0 rgba(255,255,255,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#222;
      font-family:'Cinzel', serif;
      font-weight:900;
      font-size:1.12rem;
      cursor:pointer;
      user-select:none;
      transition:.18s;
    }
    .history-stone:hover{ transform:translateY(-2px) scale(1.03); }

    .tablet{
      width:min(760px,92vw);
      height:min(880px,90vh);
      margin:0 auto;
      position:relative;
      border-radius:56px;
      background:linear-gradient(180deg,#F1EFE8,#E6E0D6);
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 60px 110px rgba(0,0,0,.32), 0 14px 22px rgba(0,0,0,.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .tablet::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(0,0,0,.10), transparent 55%),
        radial-gradient(circle at 70% 60%, rgba(0,0,0,.08), transparent 60%),
        url("data:image/svg+xml,%3Csvg viewBox='0 0 220 220' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.55'/%3E%3C/svg%3E");
      opacity:.16;
      mix-blend-mode:multiply;
    }

    .content{
      position:relative;
      z-index:5;
      width:100%;
      height:100%;
      padding:clamp(28px, 4vh, 52px) clamp(24px, 3.4vw, 48px) clamp(24px, 3vh, 40px);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:clamp(6px, 1.2vh, 14px);
      min-height:0;
    }

    /* ========== èª¿æ€§å€åŸŸ ========== */
    .tone-area{
      height:96px;
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding-top:6px;
      gap:10px;
      flex:0 0 96px;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tone-dots{
      height:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tone-bars{
      height:42px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tone-dot{
      width:22px;
      height:22px;
      background:#000;
      border-radius:50%;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tone-bar{
      width:190px;
      height:16px;
      background:#000;
      border-radius:8px;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* åœ–é¨°å€å¡Š */
    .glyph-area{
      width:100%;
      display:flex;
      justify-content:center;
      margin-top:-2px;
      margin-bottom:6px;
      flex:0 0 200px;
      align-items:center;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .glyph-frame{
      display:inline-flex;
      padding:10px;
      border-radius:24px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(0,0,0,.14);
      box-shadow:
        inset 0 4px 20px rgba(0,0,0,.30),
        inset 0 -6px 16px rgba(255,255,255,.24),
        0 14px 28px rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .glyph-frame:hover{ transform: translateY(-2px); }
    .glyph-img{
      height:180px;
      border-radius:16px;
      filter: drop-shadow(0 12px 18px rgba(0,0,0,.24));
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .kin-id{
      font-family:'Cinzel', serif;
      font-size:clamp(2.8rem, 4.8vh, 3.8rem);
      font-weight:900;
      line-height:1;
      margin-top:2px;
      min-width:9ch;
      text-align:center;
      font-variant-numeric: tabular-nums;
      font-feature-settings:"tnum" 1;
      user-select:none;
      cursor:pointer;
      color:#0E0E0E;
      flex:0 0 auto;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .kin-name{
      font-size:clamp(1.8rem, 3.5vh, 2.6rem);
      font-weight:900;
      letter-spacing:clamp(3px, .9vw, 7px);
      margin-top:4px;
      text-align:center;
      color:#111;
      flex:0 0 auto;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* æ³¢ç¬¦æ¨™ç±¤ */
    .wavespell-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 18px;
      background:rgba(0,0,0,.06);
      border-radius:999px;
      font-size:0.95rem;
      font-weight:700;
      color:#333;
      letter-spacing:1px;
      margin-top:4px;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: inset 0 1px 3px rgba(0,0,0,.08);
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .wavespell-icon{
      width:18px;
      height:18px;
      border-radius:4px;
      opacity:0.9;
    }

    .name-etch{
      width:64%;
      height:12px;
      border-radius:999px;
      background:linear-gradient(90deg, transparent 0%, var(--theme) 50%, transparent 100%);
      opacity:.64;
      margin:10px auto 12px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.14));
      flex:0 0 auto;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========== ç¸®å°æ¨¡å¼ ========== */
    .compact .tone-area{
      height:60px;
      flex-basis:60px;
      gap:6px;
      padding-top:4px;
    }
    .compact .tone-dots{
      height:18px;
      gap:10px;
    }
    .compact .tone-bars{
      height:26px;
      gap:6px;
    }
    .compact .tone-dot{
      width:14px;
      height:14px;
    }
    .compact .tone-bar{
      width:120px;
      height:10px;
    }

    .compact .glyph-area{
      flex-basis:130px;
      margin-bottom:4px;
    }
    .compact .glyph-frame{
      padding:6px;
    }
    .compact .glyph-img{
      height:118px;
    }

    .compact .kin-id{
      font-size:clamp(1.8rem, 3.2vh, 2.2rem);
      margin-top:0;
    }
    .compact .kin-name{
      font-size:clamp(1.25rem, 2.4vh, 1.7rem);
      margin-top:2px;
      letter-spacing:clamp(2px, .6vw, 4px);
    }
    .compact .wavespell-badge{
      padding:5px 12px;
      font-size:0.8rem;
      gap:6px;
    }
    .compact .wavespell-icon{
      width:14px;
      height:14px;
    }
    .compact .name-etch{
      width:50%;
      height:8px;
      margin:6px auto 10px;
    }

    /* è¨Šæ¯å€ */
    .msg-stack{
      width:92%;
      display:flex;
      flex-direction:column;
      gap:clamp(16px, 2vh, 22px);
      margin-top:0;
      flex:1 1 auto;
      min-height:0;
      animation: slideInUp 0.7s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      opacity:0;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .msg-box{
      background:rgba(245,242,236,.66);
      border-radius:32px;
      padding:clamp(20px, 2.4vh, 30px) clamp(22px, 2.6vw, 34px);
      border:1px solid rgba(0,0,0,.12);
      box-shadow:
        inset 0 3px 16px rgba(0,0,0,.24),
        0 12px 20px rgba(0,0,0,.14);
      backdrop-filter: blur(3px);
      flex-shrink:0;
    }
    .label{
      font-weight:900;
      opacity:.64;
      margin-bottom:12px;
      display:block;
      letter-spacing:2px;
      text-align:center;
      color:#111;
      font-size:1rem;
    }
    .content-text{
      font-size:clamp(1.15rem, 2.15vh, 1.48rem);
      line-height:1.9;
      font-weight:900;
      text-align:left;
      color:#0B0B0B;
      text-shadow:none;
      word-break:break-word;
    }

    .spinning-placeholder{
      width:92%;
      min-height:200px;
      margin:0 auto;
      border-radius:32px;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(0,0,0,.12);
      box-shadow:inset 0 2px 10px rgba(0,0,0,.16);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      letter-spacing:3px;
      opacity:.80;
      color:#111;
      flex:1 1 auto;
      font-size:1.1rem;
    }

    .footer{
      width:100%;
      margin-top:auto;
      padding-top:12px;
      padding-bottom:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:0;
      flex:0 0 auto;
    }

    .ritual-etch{
      width:min(240px, 62%);
      height:34px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      background:
        radial-gradient(120px 22px at 50% 60%, rgba(255,255,255,.16), transparent 65%);
      border-radius:999px;
      filter: drop-shadow(0 11px 19px rgba(0,0,0,.20));
    }
    .ritual-etch::before{
      content:"";
      width:13px;height:13px;border-radius:50%;
      background:var(--theme);
      box-shadow:
        inset 0 -3px 5px rgba(0,0,0,.38),
        0 9px 15px rgba(0,0,0,.18);
    }
    .ritual-etch::after{
      content:"";
      width:min(164px, 43vw);
      height:13px;
      border-radius:13px;
      background:var(--theme);
      box-shadow:
        inset 0 -4px 6px rgba(0,0,0,.42),
        0 11px 19px rgba(0,0,0,.18);
    }

    /* ========== å°é¢å…¥å£ï¼ˆç¥å»Ÿé–‹å ´ï¼‰========== */
    .pre-card{
      width:min(680px,88%);
      border-radius:56px;
      background:rgba(255,255,255,.11);
      border:2px solid rgba(0,0,0,.09);
      box-shadow:
        0 52px 98px rgba(0,0,0,.24),
        inset 0 3px 20px rgba(0,0,0,.20),
        inset 0 -1px 0 rgba(255,255,255,.38);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:18px;
      margin-top:clamp(16px, 3vh, 32px);
      padding:clamp(28px, 4.5vh, 44px) 20px;
      cursor:pointer;
      user-select:none;
      position:relative;
      transition: transform .25s ease;
    }
    .pre-card:hover{ transform: translateY(-4px); }

    /* å°é¢èª¿æ€§é¡¯ç¤º */
    .pre-tone{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .pre-tone-dots{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .pre-tone-dot{
      width:16px;
      height:16px;
      background:#000;
      border-radius:50%;
      opacity:0.7;
    }
    .pre-tone-bars{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
    }
    .pre-tone-bar{
      width:100px;
      height:10px;
      background:#000;
      border-radius:5px;
      opacity:0.7;
    }

    /* å°é¢åœ–é¨°æ¡† */
    .pre-glyph-frame{
      width:160px;
      height:160px;
      border-radius:28px;
      border:3px solid rgba(0,0,0,.11);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 24px 42px rgba(0,0,0,.20), inset 0 2px 14px rgba(0,0,0,.14);
      background:rgba(255,255,255,.08);
      overflow:hidden;
    }
    .pre-glyph-img{
      height:140px;
      border-radius:16px;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.20));
    }

    /* å°é¢æ³¢ç¬¦æ¨™ç±¤ */
    .pre-wavespell{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 14px;
      background:rgba(0,0,0,.05);
      border-radius:999px;
      font-size:0.85rem;
      font-weight:700;
      color:#444;
      letter-spacing:1px;
    }
    .pre-wavespell-icon{
      width:16px;
      height:16px;
      border-radius:3px;
      opacity:0.85;
    }

    .pre-kin{
      font-family:'Cinzel', serif;
      font-size:1.6rem;
      font-weight:900;
      color:#222;
      letter-spacing:2px;
    }
    .pre-name{
      font-size:1.3rem;
      font-weight:900;
      color:#333;
      letter-spacing:3px;
    }

    .pre-divider{
      width:60%;
      height:2px;
      background:linear-gradient(90deg, transparent, rgba(0,0,0,.15), transparent);
      margin:4px 0;
    }

    .pre-title{
      font-weight:900;
      letter-spacing:10px;
      color:#222;
      font-size:1.8rem;
      text-align:center;
      margin-top:6px;
    }
    .pre-sub{
      opacity:.60;
      font-weight:800;
      letter-spacing:4px;
      font-size:1.1rem;
      text-align:center;
      margin-top:-4px;
    }

    @media (max-height: 760px){
      .tablet{ height:min(820px,90vh); }
      .glyph-img{height:160px;}
      .compact .glyph-img{height:100px;}
      .pre-glyph-frame{width:130px;height:130px;}
      .pre-glyph-img{height:110px;}
      .tone-area{ height:88px; flex-basis:88px; }
      .compact .tone-area{ height:52px; flex-basis:52px; }
      .glyph-area{ flex-basis:184px; }
      .compact .glyph-area{ flex-basis:116px; }
      .kin-id{ font-size:clamp(2.5rem, 4.2vh, 3.4rem); }
      .compact .kin-id{ font-size:clamp(1.6rem, 2.8vh, 2rem); }
      .kin-name{ font-size:clamp(1.6rem, 3vh, 2.2rem); }
      .compact .kin-name{ font-size:clamp(1.1rem, 2.1vh, 1.5rem); }
      .content-text{ font-size:clamp(1.05rem, 1.95vh, 1.32rem); line-height:1.8; }
      .msg-box{ padding:clamp(16px, 2vh, 24px) clamp(18px, 2vw, 26px); }
      .msg-stack{ gap:clamp(12px, 1.6vh, 18px); }
      .pre-card{ padding:clamp(20px, 3.5vh, 36px) 16px; gap:14px; }
      .pre-title{ font-size:1.5rem; letter-spacing:8px; }
      .pre-name{ font-size:1.1rem; }
      .pre-kin{ font-size:1.4rem; }
      .content{ padding:clamp(24px, 3.5vh, 44px) clamp(20px, 3vw, 40px) clamp(20px, 2.5vh, 36px); }
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useState,useEffect,useRef} = React;

    const TONE_NAMES=["ç£æ€§çš„","æœˆäº®çš„","é›»åŠ›çš„","è‡ªæˆ‘å­˜åœ¨çš„","è¶…é »çš„","éŸ»å¾‹çš„","å…±é³´çš„","éŠ€æ²³çš„","å¤ªé™½çš„","è¡Œæ˜Ÿçš„","å…‰è­œçš„","æ°´æ™¶çš„","å®‡å®™çš„"];
    const GLYPH_NAMES=["ç´…é¾","ç™½é¢¨","è—å¤œ","é»ƒç¨®å­","ç´…è›‡","ç™½ä¸–ç•Œæ©‹","è—æ‰‹","é»ƒæ˜Ÿæ˜Ÿ","ç´…æœˆ","ç™½ç‹—","è—çŒ´","é»ƒäºº","ç´…å¤©è¡Œè€…","ç™½å·«å¸«","è—é·¹","é»ƒæˆ°å£«","ç´…åœ°çƒ","ç™½é¡","è—é¢¨æš´","é»ƒå¤ªé™½"];

    // æ³¢ç¬¦å°æ‡‰è¡¨ï¼šæ¯å€‹æ³¢ç¬¦çš„èµ·å§‹ KIN åŠå…¶åœ–é¨°
    const WAVESPELL_DATA = [
      { name: "ç´…é¾æ³¢", startKin: 1, glyphId: 0 },
      { name: "ç™½å·«å¸«æ³¢", startKin: 14, glyphId: 13 },
      { name: "è—æ‰‹æ³¢", startKin: 27, glyphId: 6 },
      { name: "é»ƒå¤ªé™½æ³¢", startKin: 40, glyphId: 19 },
      { name: "ç´…å¤©è¡Œè€…æ³¢", startKin: 53, glyphId: 12 },
      { name: "ç™½ä¸–ç•Œæ©‹æ³¢", startKin: 66, glyphId: 5 },
      { name: "è—é¢¨æš´æ³¢", startKin: 79, glyphId: 18 },
      { name: "é»ƒäººæ³¢", startKin: 92, glyphId: 11 },
      { name: "ç´…è›‡æ³¢", startKin: 105, glyphId: 4 },
      { name: "ç™½é¡æ³¢", startKin: 118, glyphId: 17 },
      { name: "è—çŒ´æ³¢", startKin: 131, glyphId: 10 },
      { name: "é»ƒç¨®å­æ³¢", startKin: 144, glyphId: 3 },
      { name: "ç´…åœ°çƒæ³¢", startKin: 157, glyphId: 16 },
      { name: "ç™½ç‹—æ³¢", startKin: 170, glyphId: 9 },
      { name: "è—å¤œæ³¢", startKin: 183, glyphId: 2 },
      { name: "é»ƒæˆ°å£«æ³¢", startKin: 196, glyphId: 15 },
      { name: "ç´…æœˆæ³¢", startKin: 209, glyphId: 8 },
      { name: "ç™½é¢¨æ³¢", startKin: 222, glyphId: 1 },
      { name: "è—é·¹æ³¢", startKin: 235, glyphId: 14 },
      { name: "é»ƒæ˜Ÿæ˜Ÿæ³¢", startKin: 248, glyphId: 7 }
    ];

    const COLORS=["red","white","blue","yellow"];
    const THEME={
      red:{main:"#A5413F",bg:"#F8E8E8"},
      white:{main:"#666666",bg:"#F2F4F6"},
      blue:{main:"#3D5A73",bg:"#E8F0F8"},
      yellow:{main:"#B39B59",bg:"#F9F8E8"}
    };

    // è¨ˆç®—ç•¶å¤©çš„ KINï¼ˆéŠ€æ²³å°è¨˜ï¼‰
    // åƒè€ƒæ—¥æœŸï¼š2025å¹´7æœˆ26æ—¥ = KIN 169ï¼ˆç£æ€§ç´…æœˆï¼Œç´…æœˆæ³¢ç¬¦é–‹å§‹ï¼‰
    // é€™æ˜¯ 13 æœˆäº®æ›†æ–°å¹´ï¼ˆç™½å…‰è­œå·«å¸«å¹´é–‹å§‹ï¼‰
    function getTodayKin() {
      const referenceDate = new Date(2025, 6, 26); // 2025å¹´7æœˆ26æ—¥
      const referenceKin = 169;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      referenceDate.setHours(0, 0, 0, 0);

      const diffTime = today.getTime() - referenceDate.getTime();
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

      let todayKin = ((referenceKin - 1 + diffDays) % 260) + 1;
      if (todayKin <= 0) todayKin += 260;

      return todayKin;
    }

    // ç²å–æ³¢ç¬¦è³‡è¨Š
    function getWavespell(kin) {
      const wavespellIndex = Math.floor((kin - 1) / 13);
      return WAVESPELL_DATA[wavespellIndex];
    }

    // èª¿æ€§é¦¬é›…æ•¸å­—æ¸²æŸ“
    function ToneDisplay({ toneId, size = "normal" }) {
      const dots = toneId % 5;
      const bars = Math.floor(toneId / 5);

      const dotClass = size === "small" ? "pre-tone-dot" : "tone-dot";
      const barClass = size === "small" ? "pre-tone-bar" : "tone-bar";
      const dotsClass = size === "small" ? "pre-tone-dots" : "tone-dots";
      const barsClass = size === "small" ? "pre-tone-bars" : "tone-bars";

      return (
        <div className={size === "small" ? "pre-tone" : "tone-area"}>
          <div className={dotsClass}>
            {[...Array(dots)].map((_, i) => <div key={i} className={dotClass}></div>)}
          </div>
          <div className={barsClass}>
            {[...Array(bars)].map((_, i) => <div key={i} className={barClass}></div>)}
          </div>
        </div>
      );
    }

    function RedRoom(){
      const [kin,setKin] = useState(1);
      const [history,setHistory] = useState([]);
      const [spinning,setSpinning] = useState(false);
      const [hasDrawn,setHasDrawn] = useState(false);
      const [showMessage,setShowMessage] = useState(false);
      const [isCompact,setIsCompact] = useState(false);
      const timerRef = useRef(null);
      const contentRef = useRef(null);

      // ç•¶å¤©çš„ KINï¼ˆç”¨æ–¼å°é¢é¡¯ç¤ºï¼‰
      const todayKin = getTodayKin();
      const todayToneId = (todayKin - 1) % 13 + 1;
      const todayGlyphId = (todayKin - 1) % 20;
      const todayWavespell = getWavespell(todayKin);
      const todayTheme = THEME[COLORS[(todayKin - 1) % 4]];

      const toneId = (kin - 1) % 13 + 1;
      const glyphId = (kin - 1) % 20;
      const wavespell = getWavespell(kin);
      const theme = THEME[COLORS[(kin - 1) % 4]];

      const brain = window.RED_BRAIN_DATA || {};
      const data = brain[String(kin)] || {
        synchronicMessage: "å®‡å®™è¨Šæ¯å°é »ä¸­...",
        alignment: "è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª red-brain.js æ ¼å¼ã€‚"
      };

      useEffect(()=>{
        // æŠ½ç‰Œå‰ç”¨ç•¶å¤©ä¸»é¡Œè‰²ï¼ŒæŠ½ç‰Œå¾Œç”¨æŠ½åˆ°çš„ä¸»é¡Œè‰²
        const activeTheme = hasDrawn ? theme : todayTheme;
        document.documentElement.style.setProperty("--bg", activeTheme.bg);
        document.documentElement.style.setProperty("--theme", activeTheme.main);
      },[theme.bg, theme.main, todayTheme.bg, todayTheme.main, hasDrawn]);

      const startSpin = ()=>{
        setHasDrawn(true);
        setSpinning(true);
        setShowMessage(false);
        setIsCompact(false);
        clearInterval(timerRef.current);
        timerRef.current = setInterval(()=>{
          setKin(Math.floor(Math.random()*260) + 1);
        }, 65);
      };

      const stopSpin = ()=>{
        clearInterval(timerRef.current);
        setSpinning(false);
        setShowMessage(false);
        setIsCompact(false);

        setTimeout(() => {
          setIsCompact(true);
          setTimeout(() => {
            setShowMessage(true);
          }, 100);
        }, 1000);

        setHistory(prev => [kin, ...prev].slice(0,5));
      };

      const toggle = ()=>{
        if(spinning) stopSpin();
        else startSpin();
      };

      const manualInput = ()=>{
        const num = prompt("å¬å–šæŒ‡å®š KIN (1-260):", kin);
        const n = parseInt(num,10);
        if(!Number.isNaN(n) && n>=1 && n<=260){
          setHasDrawn(true);
          setKin(n);
          setShowMessage(false);
          setIsCompact(false);
          setTimeout(() => {
            setIsCompact(true);
            setTimeout(() => {
              setShowMessage(true);
            }, 100);
          }, 1000);
        }
      };

      return (
        <>
          <div className="history-sidebar">
            {history.map((k,i)=>(
              <div key={i} className="history-stone" onClick={()=>!spinning && setKin(k)}>{k}</div>
            ))}
          </div>

          <div style={{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"}}>
            <div className="tablet">
              <div className={`content ${isCompact ? 'compact' : ''}`} ref={contentRef}>

                {!hasDrawn ? (
                  <>
                    {/* ===== å°é¢å…¥å£ï¼šé¡¯ç¤ºç•¶å¤©å°è¨˜ ===== */}
                    <div className="pre-card" onClick={toggle}>

                      {/* ç•¶å¤©èª¿æ€§ï¼ˆé¦¬é›…æ•¸å­—ï¼‰ */}
                      <ToneDisplay toneId={todayToneId} size="small" />

                      {/* ç•¶å¤©åœ–é¨° */}
                      <div className="pre-glyph-frame">
                        <img
                          className="pre-glyph-img"
                          src={`../images/${String(todayGlyphId + 1).padStart(2,'0')}.png`}
                          alt={GLYPH_NAMES[todayGlyphId]}
                        />
                      </div>

                      {/* ç•¶å¤© KIN èˆ‡åç¨± */}
                      <div className="pre-kin">KIN {todayKin}</div>
                      <div className="pre-name">{TONE_NAMES[todayToneId-1]}{GLYPH_NAMES[todayGlyphId]}</div>

                      {/* ç•¶å¤©æ³¢ç¬¦ */}
                      <div className="pre-wavespell">
                        <img
                          className="pre-wavespell-icon"
                          src={`../images/${String(todayWavespell.glyphId + 1).padStart(2,'0')}.png`}
                          alt={todayWavespell.name}
                        />
                        {todayWavespell.name}
                      </div>

                      <div className="pre-divider"></div>

                      <div className="pre-title">é»æ“Šé–‹å§‹å°é »</div>
                      <div className="pre-sub">è·Ÿè‘—ç›´è¦ºï¼Œé–å®šå°è¨˜</div>
                    </div>

                    <div className="footer">
                      <div className="ritual-etch"></div>
                    </div>
                  </>
                ) : (
                  <>
                    {/* ===== æŠ½ç‰Œå¾Œï¼šé¡¯ç¤ºæŠ½åˆ°çš„å°è¨˜ ===== */}
                    <ToneDisplay toneId={toneId} />

                    <div className="glyph-area">
                      <div className="glyph-frame" onClick={toggle} title="é»åœ–é¨°ï¼šé–‹å§‹/åœæ­¢å°é »">
                        <img className="glyph-img" src={`../images/${String(glyphId + 1).padStart(2,'0')}.png`} />
                      </div>
                    </div>

                    <div className="kin-id" onClick={manualInput}>KIN {kin}</div>
                    <div className="kin-name">{TONE_NAMES[toneId-1]}{GLYPH_NAMES[glyphId]}</div>

                    {/* æ³¢ç¬¦é¡¯ç¤º */}
                    <div className="wavespell-badge">
                      <img
                        className="wavespell-icon"
                        src={`../images/${String(wavespell.glyphId + 1).padStart(2,'0')}.png`}
                        alt={wavespell.name}
                      />
                      {wavespell.name}
                    </div>

                    <div className="name-etch"></div>

                    {spinning ? (
                      <div className="spinning-placeholder">å°é »ä¸­â€¦ï¼ˆåœæ­¢å¾Œé¡¯ç¤ºå®Œæ•´è¨Šæ¯ï¼‰</div>
                    ) : showMessage && (
                      <div className="msg-stack">
                        <div className="msg-box">
                          <span className="label">âš¡ èƒ½é‡æ„Ÿæ‡‰</span>
                          <div className="content-text">{data.synchronicMessage}</div>
                        </div>

                        <div className="msg-box">
                          <span className="label">ğŸŒ± èª¿é »å»ºè­°</span>
                          <div className="content-text">{data.alignment}</div>
                        </div>
                      </div>
                    )}
                  </>
                )}

              </div>
            </div>
          </div>
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<RedRoom/>);
  </script>
</body>
</html>
